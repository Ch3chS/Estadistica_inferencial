---
title: "EP-10"
date: "2023-06-12"
output: html_document
---

```{r setup, include=FALSE}
library(caret)
library(pROC)
library(tidyverse)
```


1. El equipo crea la variable IMC (índice de masa corporal) como el peso de una persona (en kilogramos) dividida por el cuadrado de su estatura (en metros).

2. Si bien esta variable se usa para clasificar a las personas en varias clases de estado nutricional (bajo peso, normal, sobrepeso, obesidad, obesidad mórbida), para efectos de este ejercicio, usaremos dos clases: sobrepeso (IMC ≥ 25,0) y no sobrepeso (IMC < 25,0).

3. El equipo crea la variable dicotómica EN (estado nutricional) de acuerdo al valor de IMC de cada persona.

```{r datos}
data <- read.csv2("EP09 Datos.csv", stringsAsFactors = TRUE) # Se lee el archivo

IMC <- data$Weight / ((data$Height / 100) ** 2)  # Se pasa la altura de centimetros a metros y se calcula IMC
EN <- ifelse(IMC > 25, 1, 0) # Se inicia un vector dicotomico  (1: Sobrepeso, 0: No sobrepeso)

data <- data.frame(data, EN)

hombres <- subset(data, Gender == 1)
hombres$Gender <- NULL
sobrepeso <- subset(hombres, EN == 1)
noSobrepeso <- subset(hombres, EN == 0)

```


Ahora podemos construir un modelo de regresión logística para predecir la variable EN, de acuerdo con las siguientes instrucciones:

1. Definir la semilla a utilizar, que corresponde a los últimos cuatro dígitos del RUN (sin considerar el dígito verificador) del integrante de mayor edad del equipo.

2. Seleccionar una muestra de 90 mujeres (si la semilla es un número par) o 90 hombres (si la semilla es impar), asegurando que la mitad tenga estado nutricional “sobrepeso” y la otra mitad “no sobrepeso” en cada caso. Dividir esta muestra en dos conjuntos: los datos de 60 personas (30 con EN “sobrepeso”) para utilizar en la construcción de los modelos y 30 personas (15 con EN “sobrepeso”) para poder evaluarlos.

```{r muestras}
set.seed(1667) # Se define la semilla según el rut del miembro mayor (ultimos 4 digitos antes del digito verificador)

# Se toma una muestra de 90 con 45 en sobrepeso y 45 que no
muestra <- merge(sample_n(sobrepeso, 45), sample_n(noSobrepeso, 45), all = TRUE)  

sobrepeso <- subset(muestra, EN == 1)
noSobrepeso <- subset(muestra, EN == 0)

# Se obtiene una submuestra de 60 con 30 en sobrepeso y 30 que no para el entrenamiento del modelo
entrenamiento <- merge(sample_n(sobrepeso, 30), sample_n(noSobrepeso, 30), all = TRUE)  

# De la muestra original (de 90) se toman los datos restantes (que no son destinados al entrenamiento), para usarlos para la proxima evaluacion del modelo
evaluacion <- anti_join(muestra, entrenamiento, by = names(muestra))
```

3.Recordar las ocho posibles variables predictoras seleccionadas de forma aleatoria en el ejercicio anterior.

```{r predictoras}
predictores <- c("Biacromial.diameter", "Calf.Maximum.Girth", "Chest.depth", "Bicep.Girth", "Bitrochanteric.diameter", "Age", "Elbows.diameter", "Hip.Girth")
```

4. Seleccionar, de las otras variables, una que el equipo considere que podría ser útil para predecir la clase EN, justificando bien esta selección.

```{r matriz correlacion}
respuesta <- entrenamiento[["EN"]]
entrenamiento[["EN"]] <- NULL

matriz <- entrenamiento %>% select(-any_of(predictores))
correlacion <- cor(matriz, y = respuesta)
correlacion
mejor <- which(correlacion == max(abs(correlacion)))
predictor <- rownames(correlacion)[mejor]
predictor
```

5. Usando el entorno R y paquetes estándares1, construir un modelo de regresión logística con el predictor seleccionado en el paso anterior y utilizando de la muestra obtenida.

```{r logit}
modelo_1 <- glm(respuesta ~ Navel.Girth, family = binomial(link = "logit"), data = entrenamiento)
```

6. Usando herramientas estándares1 para la exploración de modelos del entorno R, buscar entre dos y cinco predictores de entre las variables seleccionadas al azar, recordadas en el punto 3, para agregar al modelo obtenido en el paso 5.

7. Evaluar la confiabilidad de los modelos (i.e. que tengan un buen nivel de ajuste y son generalizables) y “arreglarlos” en caso de que tengan algún problema.

8. Usando código estándar1, evaluar el poder predictivo de los modelos con los datos de las 40 personas que no se incluyeron en su construcción en términos de sensibilidad y especificidad.

```{r evaluacion}
umbral <- 0.5

probs_1 <- predict(modelo_1, evaluacion, type = "response")
preds_1 <- sapply(probs_1, function(p) ifelse(p >= umbral, "1" , "0"))
preds_1 <- factor(preds_1)

ROC_1 <- roc(evaluacion$EN, probs_1)
matriz <- confusionMatrix(preds_1, as.factor(evaluacion$EN))

plot(ROC_1)
# La curva se aleja bastante de la diagonal por lo que parece ser un buen modelo
matriz
```